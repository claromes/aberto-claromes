name: Post to LinkedIn Page

on:
  schedule:
    - cron: '0 0 */2 * *'
  workflow_dispatch:

jobs:
  post-linkedin:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository content
        uses: actions/checkout@v3

      - name: Get GitHub activities
        id: get_activities
        run: |
          activities=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/users/claromes/events | jq '.[0:5]')
          
          if [ -z "$activities" ]; then
            echo "No GitHub activities found."
            exit 1
          fi

          echo "$activities" | jq -r '
            .[] |
            "Tipo: \(.type)\nRepositório: https://github.com/\(.repo.name)\nMensagem: \(.payload.commits[0].message // "Nenhuma mensagem")\nRef: \(.payload.ref // "Nenhuma ref")\nCriado em: \(.created_at)"
          ' > activities.txt

      - name: Send update to LinkedIn Page
        run: |
          activities_text=$(cat activities.txt)
        
          curl -X POST https://api.linkedin.com/v2/ugcPosts \
            -H "Authorization: Bearer ${{ secrets.LINKEDIN_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "author": "urn:li:organization:104661399",
              "lifecycleState": "PUBLISHED",
              "specificContent": {
                "com.linkedin.ugc.ShareContent": {
                  "shareCommentary": {
                    "text": "Atividades recentes do GitHub:\n'"${{ env.ACTIVITIES }}"'\nEsta é uma postagem automática."
                  },
                  "shareMediaCategory": "NONE"
                }
              },
              "visibility": {
                "com.linkedin.ugc.MemberNetworkVisibility": "PUBLIC"
              }
            }'
